{% extends "navbar.html" %}

{% block title %}unir archivos...{% endblock %}

{% block content %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unir archivos Excel - Coltrade</title>

  <!-- CSS (estilo "premium" limpio) -->
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa6b2;
      --accent:#1e90ff;
      --success:#16a34a;
      --danger:#dc2626;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
      font-family: "Arial", sans-serif;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071126 0%, #071a2b 60%);color:#e6eef6}
    .wrap{max-width:1100px;margin:36px auto;padding:28px;background:var(--glass);border-radius:18px;box-shadow:0 10px 40px rgba(2,6,23,0.7);backdrop-filter: blur(6px);}
    header{display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:18px}
    h1{margin:0;font-size:20px;letter-spacing:0.2px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:18px 0}
    .btn{
      background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.06);
      color:var(--e6eef6);
      padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:600;
      box-shadow:0 6px 18px rgba(2,6,23,0.5);
    }
    .btn.primary{background:linear-gradient(90deg,var(--accent),#4da6ff);color:#041124;border: font-weight:700}
    .file-input{
      position:relative;overflow:hidden;border-radius:12px;padding:8px 12px;border:1px dashed rgba(255,255,255,0.06);display:flex;align-items:center;gap:10px;min-width:320px;
      background:rgba(255,255,255,0.01)
    }
    .file-input input[type=file]{opacity:0;position:absolute;left:0;top:0;width:100%;height:100%;cursor:pointer}

    .preview-area{margin-top:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{position:sticky;top:0;background:rgba(2,6,23,0.6);text-align:left;padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-weight:700}
    tbody td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);color:var(--muted)}
    .cell-pos{color:var(--success);font-weight:600}
    .cell-neg{color:var(--danger);font-weight:600}

    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .small{font-size:12px;color:var(--muted)}
    .actions{margin-left:auto}

    /* responsive */
    @media (max-width:820px){
      .wrap{margin:12px;padding:16px}
      header{flex-direction:column;align-items:flex-start;gap:8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Unir archivos Excel • Coltrade</h1>
        <p class="lead">Sube varios archivos .xls/.xlsx, únelos y descarga el resultado con las columnas filtradas y en el orden requerido.</p>
      </div>
      <div class="small">Archivos: .xls / .xlsx — Se mantendrán y reordenarán columnas.</div>
    </header>

    <div class="controls">
      <label class="file-input">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:0.9"><path d="M12 5v14" stroke="white" stroke-width="1.6" stroke-linecap="round"/><path d="M5 12h14" stroke="white" stroke-width="1.6" stroke-linecap="round"/></svg>
        <span id="fileLabel">Seleccionar archivos (múltiples)</span>
        <input id="files" type="file" multiple accept=".xls,.xlsx" />
      </label>

      <button id="previewBtn" class="btn">Previsualizar</button>
      <button id="mergeBtn" class="btn primary">Unir y Descargar</button>

      <div class="actions hint">Formato final: <strong>Centro Costos, Punto de Venta, Material, Producto, Marca, Ventas Actuales, Transitos, Inventario, Envío Inventario 3 meses, Sugerido</strong></div>
    </div>

    <div id="status" class="hint"></div>

    <div class="preview-area">
      <div id="previewContainer">
        <em class="hint">Aquí aparecerá una previsualización (hasta 200 filas) tras pulsar "Previsualizar".</em>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script>
    const filesInput = document.getElementById('files');
    const fileLabel = document.getElementById('fileLabel');
    const previewBtn = document.getElementById('previewBtn');
    const mergeBtn = document.getElementById('mergeBtn');
    const previewContainer = document.getElementById('previewContainer');
    const status = document.getElementById('status');

    filesInput.addEventListener('change', () => {
      const n = filesInput.files.length;
      fileLabel.textContent = n ? `${n} archivo(s) seleccionado(s)` : 'Seleccionar archivos (múltiples)';
    });

    async function postFiles(url){
      const f = filesInput.files;
      if(!f || f.length === 0){
        alert("Selecciona al menos un archivo .xlsx o .xls");
        return null;
      }
      const form = new FormData();
      for(let i=0;i<f.length;i++){
        form.append('files[]', f[i], f[i].name);
      }

      const resp = await fetch(url, {
        method:'POST',
        body: form
      });
      return resp;
    }

    previewBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      status.textContent = "Generando previsualización...";
      previewContainer.innerHTML = '';
      try{
        const resp = await postFiles('/unir/preview');
        if (!resp) return;
        if (!resp.ok){
          const err = await resp.json().catch(()=>({error:'Error desconocido'}));
          status.textContent = "Error: " + (err.error || "Respuesta no válida");
          return;
        }
        const data = await resp.json();
        if (data.error){
          status.textContent = "Error: " + data.error;
          return;
        }
        buildPreviewTable(data.columns, data.rows);
        status.textContent = `Previsualizando ${data.rows.length} fila(s) — columnas: ${data.columns.join(', ')}`;
      }catch(err){
        status.textContent = "Error al previsualizar: " + err.message;
      }
    });

    mergeBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if(!filesInput.files || filesInput.files.length === 0){
        alert("Selecciona al menos un archivo antes de unir.");
        return;
      }
      mergeBtn.disabled = true;
      mergeBtn.textContent = "Preparando descarga...";
      try{
        const resp = await postFiles('/unir/merge');
        if(!resp) return;
        if(!resp.ok){
          const err = await resp.json().catch(()=>({error:'Error desconocido'}));
          throw new Error(err.error || 'Error al generar archivo');
        }
        const blob = await resp.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'unido.xlsx';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
        status.textContent = "Descarga iniciada: unido.xlsx";
      }catch(err){
        status.textContent = "Error al descargar: " + err.message;
      }finally{
        mergeBtn.disabled = false;
        mergeBtn.textContent = "Unir y Descargar";
      }
    });

    function buildPreviewTable(columns, rows){
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      columns.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      rows.forEach(row => {
        const tr = document.createElement('tr');
        for(let i=0;i<columns.length;i++){
          const td = document.createElement('td');
          const val = row[i];

          // Colorear numéricos en columnas específicas si existen
          const colName = columns[i];
          if ((colName === 'Envío Inventario 3 meses' || colName === 'Envío Ventas Actuales') && val !== null && val !== '') {
            // intentar parsear número (string con coma decimal -> punto)
            let parsed = parseFloat(String(val).replace(',', '.'));
            if (!isNaN(parsed)){
              td.textContent = parsed;
              td.className = parsed >= 0 ? 'cell-pos' : 'cell-neg';
            } else {
              td.textContent = val;
            }
          } else {
            td.textContent = val;
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      previewContainer.innerHTML = '';
      previewContainer.appendChild(table);
    }
  </script>
</body>
</html>

{% endblock %}

